<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.7">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Helvetica Neue'}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px 'Helvetica Neue'; min-height: 15.0px}
    span.s1 {font: 13.0px 'Apple Symbols'}
  </style>
</head>
<body>
<p class="p1">&lt;!DOCTYPE html&gt;</p>
<p class="p1">&lt;html lang="en"&gt;</p>
<p class="p1">&lt;head&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;meta charset="UTF-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;title&gt;Wk Easy Pedigree - Active Style Highlights&lt;/title&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;script src="https://unpkg.com/konva@9.2.0/konva.min.js"&gt;&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>body { margin: 0; padding: 0; overflow: hidden; background-color: #f8f9fa; font-family: sans-serif; touch-action: none; }</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>/* Main Header Toolbar */</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>#toolbar {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>position: relative; width: 100%; box-sizing: border-box;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>background: white; padding: 10px 15px; border-bottom: 1px solid #ddd;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>display: flex; flex-wrap: wrap; gap: 10px; align-items: center; user-select: none;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>/* Context Menu (Desktop Right Click) */</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>#context-menu {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>display: none; position: fixed; background: white; padding: 10px;<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>border-radius: 8px; border: 1px solid #ccc; box-shadow: 0 4px 15px rgba(0,0,0,0.2);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>z-index: 1000; flex-direction: column; gap: 8px; align-items: flex-start; user-select: none; min-width: 120px;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>/* Mobile/Desktop Editor (Double Click/Tap) */</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>#node-editor {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>display: none; position: fixed; z-index: 1001; background: white; padding: 12px;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>border-radius: 12px; border: 1px solid #ccc; box-shadow: 0 5px 25px rgba(0,0,0,0.3);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>flex-direction: column; gap: 10px; min-width: 220px;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>.menu-row, .editor-row { display: flex; gap: 5px; align-items: center; width: 100%; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>.menu-label { font-size: 11px; font-weight: bold; color: #666; margin-bottom: 2px; display: block; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>button {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>padding: 6px 12px; cursor: pointer; border: 1px solid #ccc;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>background: #fff; border-radius: 4px; font-weight: 600; font-size: 16px;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>display: flex; align-items: center; justify-content: center; gap: 5px; transition: all 0.2s; min-width: 40px;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>button:hover { background-color: #f0f0f0; transform: translateY(-1px); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>button.active { background-color: #e3f2fd; border-color: #2196f3; color: #0d47a1; box-shadow: inset 0 0 3px rgba(33, 150, 243, 0.2); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>button.danger { color: #d32f2f; border-color: #ef9a9a; } button.danger:hover { background-color: #ffebee; }</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>button.style-btn, .editor-btn { flex: 1; padding: 8px; justify-content: center; font-size: 16px; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>button.text-btn { font-size: 13px; min-width: auto; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>.sep { width: 1px; height: 20px; background: #ddd; margin: 0 2px; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>/* Editor Input */</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>#editor-name { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 16px; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>#instructions {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>position: absolute; bottom: 15px; left: 15px;<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>color: #444; font-size: 12px; pointer-events: none; border: 1px solid #ddd;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;/style&gt;</p>
<p class="p1">&lt;/head&gt;</p>
<p class="p1">&lt;body&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;div id="toolbar"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;button title="Add Male" onclick="addPersonAction('male')"&gt;â¬œ&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;button title="Add Female" onclick="addPersonAction('female')"&gt;âšª&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;div class="sep"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;button class="text-btn" id="btn-connect" onclick="toggleConnectMode()"&gt;ğŸ”— Link Mode: OFF&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;div class="sep"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;button title="Undo" onclick="undo()"&gt;â†©ï¸&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;button title="Redo" onclick="redo()"&gt;â†ªï¸&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;div class="sep"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;button class="danger text-btn" onclick="deleteSelectedAction()"&gt;ğŸ—‘ï¸ Del&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;div class="sep"&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;button title="Save Image" onclick="downloadImage()"&gt;ğŸ’¾&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;button class="danger text-btn" onclick="clearCanvasAction()"&gt;âŒ Clear&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;!-- Node Editor (Double Tap) --&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;div id="node-editor"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;span class="menu-label"&gt;Name&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;input type="text" id="editor-name" placeholder="Name"&gt;</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;span class="menu-label"&gt;Fill Style&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;div class="editor-row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;button id="edit-btn-white" class="editor-btn" onclick="setEditorStyle('white')" title="Unaffected"&gt;â¬œ&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;button id="edit-btn-half" class="editor-btn" onclick="setEditorStyle('half')" title="Carrier"&gt;ğŸŒ“&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;button id="edit-btn-black" class="editor-btn" onclick="setEditorStyle('black')" title="Affected"&gt;â¬›&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;span class="menu-label"&gt;Markers&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;div class="editor-row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;button id="edit-btn-deceased" class="editor-btn" onclick="toggleEditorDeceased()"&gt;<span class="s1">âŠ˜</span> Slash&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;button id="edit-btn-proband" class="editor-btn" onclick="toggleEditorProband()"&gt;â†™ï¸ Index&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;button onclick="closeEditor()" style="width:100%; margin-top:5px; background:#2196f3; color:white; border:none;"&gt;Done&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;!-- Context Menu (Right Click backup) --&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;div id="context-menu" oncontextmenu="return false;"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;div id="menu-node-options" class="menu-group"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;span class="menu-label"&gt;Quick Actions&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;div class="menu-row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>&lt;button id="ctx-btn-white" class="style-btn" onclick="setShapeFill('white')"&gt;â¬œ&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>&lt;button id="ctx-btn-half" class="style-btn" onclick="setShapeFill('half')"&gt;ğŸŒ“&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>&lt;button id="ctx-btn-black" class="style-btn" onclick="setShapeFill('black')"&gt;â¬›&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;div class="menu-row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>&lt;button id="ctx-btn-deceased" class="style-btn" onclick="toggleDeceased()"&gt;<span class="s1">âŠ˜</span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>&lt;button id="ctx-btn-proband" class="style-btn" onclick="toggleProband()"&gt;â†™ï¸&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;div id="menu-line-options" class="menu-group" style="display:none;"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;span class="menu-label"&gt;Line Style&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;div class="menu-row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>&lt;button id="ctx-btn-sep" class="style-btn" onclick="toggleSeparated()"&gt;<span class="s1">â«½</span>&lt;/button&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;div id="instructions"&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;b&gt;Connect:&lt;/b&gt; Link mode &gt; Tap shape to shape/line&lt;br&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>&lt;b&gt;Edit:&lt;/b&gt; Double-tap&lt;br&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>"Enjoy easy pedigree by WichkuğŸ˜"</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;div id="container"&gt;&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;script&gt;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const GRID_SIZE = 80;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const SHAPE_SIZE = 40;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const DARK_GREY = '#444444';<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const toolbarEl = document.getElementById('toolbar');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const VIRTUAL_SIZE = 10000; // Large drawing area</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function getStageDims() {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>return { width: window.innerWidth, height: window.innerHeight - toolbarEl.offsetHeight };</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const dims = getStageDims();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const stage = new Konva.Stage({ container: 'container', width: dims.width, height: dims.height });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const layer = new Konva.Layer();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const gridLayer = new Konva.Layer();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const dragLayer = new Konva.Layer();<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>stage.add(gridLayer); stage.add(layer); stage.add(dragLayer);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function drawGrid() {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>gridLayer.destroyChildren();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const start = -VIRTUAL_SIZE / 2;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const end = VIRTUAL_SIZE / 2;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>for (let x = start; x &lt;= end; x += GRID_SIZE) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>gridLayer.add(new Konva.Line({ points: [x, start, x, end], stroke: '#e0e0e0', strokeWidth: 1, dash: [4, 4] }));</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>for (let y = start; y &lt;= end; y += GRID_SIZE) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>gridLayer.add(new Konva.Line({ points: [start, y, end, y], stroke: '#e0e0e0', strokeWidth: 1, dash: [4, 4] }));</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>gridLayer.add(new Konva.Circle({ x: 0, y: 0, radius: 3, fill: '#ccc' }));</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>drawGrid();</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>stage.x(dims.width/2);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>stage.y(dims.height/2);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>let isConnectMode = false, idCounter = 1;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>let selectedNodes = [], selectedLine = null, connections = [], historyStack = [], redoStack = [];</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>let isSelecting = false, selectionStart = {x:0,y:0};</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const selectionRect = new Konva.Rect({ fill: 'rgba(33, 150, 243, 0.2)', stroke: '#2196f3', visible: false });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>dragLayer.add(selectionRect);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>// --- ZOOM &amp; PAN LOGIC ---</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>let lastCenter = null;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>let lastDist = 0;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>stage.on('touchmove', function (e) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const touch1 = e.evt.touches[0];</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const touch2 = e.evt.touches[1];</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if (touch1 &amp;&amp; touch2) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>e.evt.preventDefault();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if(isSelecting) { isSelecting=false; selectionRect.visible(false); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if(stage.isDragging()) stage.stopDrag();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const p1 = { x: touch1.clientX, y: touch1.clientY };</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const p2 = { x: touch2.clientX, y: touch2.clientY };</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if (!lastCenter) { lastCenter = getCenter(p1, p2); return; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const newCenter = getCenter(p1, p2);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const dist = getDistance(p1, p2);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if (!lastDist) lastDist = dist;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const pointTo = {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>x: (newCenter.x - stage.x()) / stage.scaleX(),</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>y: (newCenter.y - stage.y()) / stage.scaleX(),</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>};</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const scale = stage.scaleX() * (dist / lastDist);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>stage.scale({ x: scale, y: scale });</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const dx = newCenter.x - lastCenter.x;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const dy = newCenter.y - lastCenter.y;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const newPos = { x: newCenter.x - pointTo.x * scale + dx, y: newCenter.y - pointTo.y * scale + dy };</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>stage.position(newPos);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>lastDist = dist;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>lastCenter = newCenter;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>stage.on('touchend', function () { lastDist = 0; lastCenter = null; });</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>stage.on('wheel', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>e.evt.preventDefault();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const scaleBy = 1.1;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const oldScale = stage.scaleX();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const pointer = stage.getPointerPosition();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const mousePointTo = { x: (pointer.x - stage.x()) / oldScale, y: (pointer.y - stage.y()) / oldScale };</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const direction = e.evt.deltaY &gt; 0 ? -1 : 1;<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const newScale = direction &gt; 0 ? oldScale * scaleBy : oldScale / scaleBy;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if (newScale &lt; 0.1 || newScale &gt; 5) return;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>stage.scale({ x: newScale, y: newScale });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const newPos = { x: pointer.x - mousePointTo.x * newScale, y: pointer.y - mousePointTo.y * newScale };</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>stage.position(newPos);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function getDistance(p1, p2) { return Math.sqrt(Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2)); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function getCenter(p1, p2) { return { x: (p1.x + p2.x) / 2, y: (p1.y + p2.y) / 2 }; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function saveHistory() {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>redoStack = [];<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const state = JSON.stringify({</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>idCounter,<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>nodes: layer.find('.person-group').map(g =&gt; ({</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>id: g.id(), x: g.x(), y: g.y(), type: g.getAttr('personType'), name: g.findOne('.label-text').text(),</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>fillType: g.getAttr('fillType')||'white', isProband: g.getAttr('isProband'), isDeceased: g.getAttr('isDeceased')</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>})),</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>connections: connections.map(c =&gt; ({</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>id: c.id, type: c.type, p1Id: c.p1Id, p2Id: c.p2Id, parentConnId: c.parentConnId, childId: c.childId, isSeparated: c.isSeparated</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>}))</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>});</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>historyStack.push(state); if(historyStack.length&gt;20) historyStack.shift();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function undo() { if(historyStack.length){ const s=historyStack.pop(); redoStack.push(JSON.stringify(serializeState())); loadState(JSON.parse(s)); } }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function redo() { if(redoStack.length){ const s=redoStack.pop(); historyStack.push(JSON.stringify(serializeState())); loadState(JSON.parse(s)); } }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function serializeState() { return { idCounter, nodes: layer.find('.person-group').map(g=&gt;({id:g.id(),x:g.x(),y:g.y(),type:g.getAttr('personType'),name:g.findOne('.label-text').text(),fillType:g.getAttr('fillType'),isProband:g.getAttr('isProband'),isDeceased:g.getAttr('isDeceased')})), connections: connections.map(c=&gt;({id:c.id,type:c.type,p1Id:c.p1Id,p2Id:c.p2Id,parentConnId:c.parentConnId,childId:c.childId,isSeparated:c.isSeparated})) }; }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function loadState(state) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>layer.destroyChildren(); connections=[]; clearSelection(); hideContextMenu(); closeEditor();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>idCounter = state.idCounter;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>state.nodes.forEach(d=&gt;createNode(d.x,d.y,d.type,d.id,d.name,d.fillType,d.isProband,d.isDeceased));</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>state.connections.filter(c=&gt;c.type==='marriage').forEach(c=&gt;createMarriage(layer.findOne('#'+c.p1Id),layer.findOne('#'+c.p2Id),c.id,false,c.isSeparated));</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>state.connections.filter(c=&gt;c.type==='descent').forEach(c=&gt;{</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const p=connections.find(x=&gt;x.id===c.parentConnId), ch=layer.findOne('#'+c.childId);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if(p&amp;&amp;ch) createDescent(p,ch,c.id,false);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>});</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>layer.draw();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function findEmptyPosition() {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const transform = stage.getAbsoluteTransform().copy().invert();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const topLeft = transform.point({ x: 0, y: 0 });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const bottomRight = transform.point({ x: stage.width(), y: stage.height() });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const startX = Math.round(topLeft.x / GRID_SIZE) * GRID_SIZE;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const startY = Math.round(topLeft.y / GRID_SIZE) * GRID_SIZE;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const endX = Math.round(bottomRight.x / GRID_SIZE) * GRID_SIZE;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const endY = Math.round(bottomRight.y / GRID_SIZE) * GRID_SIZE;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const centerX = (startX + endX) / 2;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const centerY = (startY + endY) / 2;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const range = 5;<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const cxGrid = Math.round(centerX/GRID_SIZE);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const cyGrid = Math.round(centerY/GRID_SIZE);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>for(let r=0; r&lt;range*2; r++) {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>for(let x=-r; x&lt;=r; x++) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>for(let y=-r; y&lt;=r; y++) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>const tx=(cxGrid+x)*GRID_SIZE, ty=(cyGrid+y)*GRID_SIZE;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>if(!layer.find('.person-group').some(n=&gt;{ const dx=n.x()-tx, dy=n.y()-ty; return Math.sqrt(dx*dx+dy*dy)&lt;GRID_SIZE/2; })) return {x:tx, y:ty};</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>return {x:centerX, y:centerY};</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function addPersonAction(t) { saveHistory(); const p=findEmptyPosition(); createNode(p.x, p.y, t, 'node-'+idCounter++, '', 'white', false, false); }</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function deleteSelectedAction() {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(selectedNodes.length || selectedLine) {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>saveHistory();<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>selectedNodes.forEach(n =&gt; deleteNode(n));</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if(selectedLine) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>const conn = getAssociatedConn(selectedLine);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>if (conn) deleteConnection(conn);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>selectedNodes = [];</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>selectedLine = null;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>hideContextMenu();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>closeEditor();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function clearCanvasAction() { saveHistory(); layer.destroyChildren(); connections=[]; idCounter=1; clearSelection(); }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function createNode(x, y, type, id, name, fill, isProband, isDeceased) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const grp = new Konva.Group({</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>x, y, draggable: true, name: 'person-group', id,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>personType: type, fillType: fill, isProband, isDeceased,</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>dragBoundFunc: pos =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>const scale = stage.scaleX();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>const sx = stage.x();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>const sy = stage.y();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>const dx = Math.round(((pos.x - sx) / scale) / GRID_SIZE) * GRID_SIZE;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>const dy = Math.round(((pos.y - sy) / scale) / GRID_SIZE) * GRID_SIZE;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>return { x: dx * scale + sx, y: dy * scale + sy };</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>});</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const size=SHAPE_SIZE;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const props = { stroke:'black', strokeWidth:2, name:'shape-body', shadowColor:'black', shadowBlur:2, shadowOpacity:0.1 };</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const shape = type==='male' ? new Konva.Rect({...props, width:size, height:size, offsetX:size/2, offsetY:size/2}) : new Konva.Circle({...props, radius:size/2});</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const arrow = new Konva.Arrow({ points:[-35,35,-15,15], pointerLength:8, pointerWidth:8, fill:'black', stroke:'black', strokeWidth:2, name:'proband-arrow', visible:isProband });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const slash = new Konva.Line({ points:[-24,24,24,-24], stroke:'black', strokeWidth:2, name:'deceased-slash', visible:isDeceased });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const label = new Konva.Text({ text:name, fontSize:12, fontFamily:'Arial', fill:'#555', y:size/2+8, width:100, offsetX:50, align:'center', name:'label-text' });</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>grp.add(shape, slash, arrow, label);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>applyFillStyle(shape, fill);</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>grp.on('dragstart', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>hideContextMenu(); closeEditor();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if(!isSelected(grp) &amp;&amp; !e.evt.shiftKey) selectSingle(grp);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>saveHistory(); selectedNodes.forEach(n =&gt; { n.sdx=n.x(); n.sdy=n.y(); });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>});</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>grp.on('dragmove', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const dx=e.target.x()-e.target.sdx, dy=e.target.y()-e.target.sdy;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>selectedNodes.forEach(n =&gt; { if(n!==e.target) { n.x(n.sdx+dx); n.y(n.sdy+dy); } });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>updateAllConnections();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>});</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>grp.on('click tap', (e) =&gt; { e.cancelBubble=true; handleNodeClick(grp, e); });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>grp.on('dblclick dbltap', () =&gt; { hideContextMenu(); showNodeEditor(grp); });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>grp.on('contextmenu', (e) =&gt; { e.evt.preventDefault(); if(!isSelected(grp)) selectSingle(grp); showContextMenu(e, 'node'); });</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>layer.add(grp); return grp;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function createMarriage(p1, p2, id=Date.now(), save=true, isSeparated=false) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(save) saveHistory();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const line = new Konva.Line({ stroke:'black', strokeWidth:2 });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const hit = new Konva.Line({ stroke:'transparent', strokeWidth:20, name:'link-hit-area', listening:true });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const slash = new Konva.Line({ points:[0,0,0,0], stroke:'black', strokeWidth:2, visible:isSeparated });</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>setupLineEvents(hit, line);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>layer.add(line, slash, hit); line.moveToBottom(); slash.moveToBottom(); hit.moveToBottom();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>connections.push({ type:'marriage', id, p1Id:p1.id(), p2Id:p2.id(), line, hitLine:hit, slash, isSeparated });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>updateAllConnections();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function createDescent(parent, child, id=Date.now(), save=true) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(save) saveHistory();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const line = new Konva.Line({ stroke:'black', strokeWidth:2 });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const hit = new Konva.Line({ stroke:'transparent', strokeWidth:15, name:'link-hit-area', listening:true });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>setupLineEvents(hit, line);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>layer.add(line, hit); line.moveToBottom(); hit.moveToBottom();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>connections.push({ type:'descent', id, parentConnId:parent.id, childId:child.id(), line, hitLine:hit });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>updateAllConnections();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function setupLineEvents(hit, vis) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>hit.on('mouseover', () =&gt; { document.body.style.cursor='pointer'; vis.strokeWidth(4); });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>hit.on('mouseout', () =&gt; { document.body.style.cursor='default'; if(selectedLine!==hit) vis.strokeWidth(2); });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>hit.on('click tap', function(e) { e.cancelBubble=true; hideContextMenu(); if(isConnectMode) handleConnectionLogic(this); else selectLine(this); });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>hit.on('dblclick dbltap', function(e) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>e.cancelBubble = true;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const c = getAssociatedConn(this);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if(c &amp;&amp; c.type === 'marriage') {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>saveHistory();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>c.isSeparated = !c.isSeparated;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>c.slash.visible(c.isSeparated);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>layer.draw();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>});</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>hit.on('contextmenu', function(e) { e.evt.preventDefault(); if(getAssociatedConn(this).type==='marriage'){ selectLine(this); showContextMenu(e, 'line'); } });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function getAssociatedConn(h) { return connections.find(c =&gt; c.hitLine===h); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function updateAllConnections() {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>connections.filter(c =&gt; c.type==='marriage').forEach(c =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const p1=layer.findOne('#'+c.p1Id), p2=layer.findOne('#'+c.p2Id);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if(!p1||!p2) return;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>c.line.points([p1.x(),p1.y(),p2.x(),p2.y()]); c.hitLine.points([p1.x(),p1.y(),p2.x(),p2.y()]);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>c.midX=(p1.x()+p2.x())/2; c.midY=(p1.y()+p2.y())/2;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if(c.slash) { c.slash.points([c.midX-6,c.midY+12,c.midX+6,c.midY-12]); c.slash.visible(c.isSeparated); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>});</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>connections.filter(c =&gt; c.type==='descent').forEach(c =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const p=connections.find(x=&gt;x.id===c.parentConnId), ch=layer.findOne('#'+c.childId);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if(!p||!ch) return;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>let turnY = (p.midY + ch.y()) / 2;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if (Math.abs(ch.y() - p.midY) &gt;= GRID_SIZE * 2) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>turnY = p.midY + (GRID_SIZE / 2);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const pts=[p.midX,p.midY,p.midX,turnY,ch.x(),turnY,ch.x(),ch.y()];</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>c.line.points(pts); c.hitLine.points(pts);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>});</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function deleteNode(n) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const nid=n.id(), toDel=[];</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>connections.forEach(c =&gt; { if((c.childId===nid)||(c.p1Id===nid||c.p2Id===nid)) toDel.push(c); });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>toDel.forEach(c =&gt; deleteConnection(c)); n.destroy(); layer.draw();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function deleteConnection(c) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(c.type==='marriage') connections.filter(d=&gt;d.parentConnId===c.id).forEach(deleteConnection);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>c.line.destroy(); c.hitLine.destroy(); if(c.slash) c.slash.destroy();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>connections = connections.filter(x=&gt;x!==c); layer.draw();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const editor = document.getElementById('node-editor');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const editorName = document.getElementById('editor-name');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>let editingNode = null;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function showNodeEditor(node) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>editingNode = node;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>editorName.value = node.findOne('.label-text').text();</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const shapePos = node.getAbsolutePosition();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const stageBox = stage.container().getBoundingClientRect();</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>let left = stageBox.left + shapePos.x - 100;<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>let top = stageBox.top + shapePos.y + 60;</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if (left &lt; 10) left = 10;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if (left + 220 &gt; window.innerWidth) left = window.innerWidth - 230;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if (top + 200 &gt; window.innerHeight) top = stageBox.top + shapePos.y - 210;<span class="Apple-converted-space">Â </span></p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>editor.style.left = left + 'px';</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>editor.style.top = top + 'px';</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>editor.style.display = 'flex';</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>editorName.focus();</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>// Highlight buttons based on node state</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>updateEditorButtons(node);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function updateEditorButtons(node) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const fill = node.getAttr('fillType') || 'white';</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const isDeceased = node.getAttr('isDeceased') || false;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const isProband = node.getAttr('isProband') || false;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>// Reset Fill</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>['edit-btn-white', 'edit-btn-half', 'edit-btn-black'].forEach(id =&gt; document.getElementById(id).classList.remove('active'));</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>// Set Active Fill</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if (fill === 'white') document.getElementById('edit-btn-white').classList.add('active');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>else if (fill === 'half') document.getElementById('edit-btn-half').classList.add('active');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>else if (fill === 'black') document.getElementById('edit-btn-black').classList.add('active');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>// Set Markers</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const btnDec = document.getElementById('edit-btn-deceased');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>isDeceased ? btnDec.classList.add('active') : btnDec.classList.remove('active');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const btnProb = document.getElementById('edit-btn-proband');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>isProband ? btnProb.classList.add('active') : btnProb.classList.remove('active');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function closeEditor() {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if (editingNode) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>saveHistory();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>editingNode.findOne('.label-text').text(editorName.value);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>editor.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>editingNode = null;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>editorName.addEventListener("keypress", (e) =&gt; { if(e.key==="Enter") closeEditor(); });</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function setEditorStyle(t) {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(editingNode) {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>saveHistory();<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>editingNode.setAttr('fillType',t);<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>applyFillStyle(editingNode.findOne('.shape-body'), t);<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>updateEditorButtons(editingNode);<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>layer.draw();<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function toggleEditorDeceased() {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(editingNode) {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>saveHistory();<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const s=editingNode.findOne('.deceased-slash');<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>s.visible(!s.visible());<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>editingNode.setAttr('isDeceased', s.visible());<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>updateEditorButtons(editingNode);<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>layer.draw();<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function toggleEditorProband() {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(editingNode) {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>saveHistory();<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const a=editingNode.findOne('.proband-arrow');<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>a.visible(!a.visible());<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>editingNode.setAttr('isProband', a.visible());<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>updateEditorButtons(editingNode);<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>layer.draw();<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function isSelected(n) { return selectedNodes.includes(n); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function selectSingle(n) { clearSelection(); selectedNodes=[n]; highlightNodes(); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function selectMultiple(ns) { clearSelection(); selectedNodes=ns; highlightNodes(); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function highlightNodes() { selectedNodes.forEach(n =&gt; { const s = n.findOne('.shape-body'); if(s) s.stroke('#2196f3').strokeWidth(3); }); }</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function clearSelection() {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>selectedNodes.forEach(n =&gt; {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if (n.getParent()) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>const s = n.findOne('.shape-body');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>if(s) s.stroke('black').strokeWidth(2);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>});<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>selectedNodes=[];<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(selectedLine){</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const conn = getAssociatedConn(selectedLine);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if(conn &amp;&amp; conn.line) conn.line.stroke('black');<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>selectedLine=null;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function selectLine(h) { clearSelection(); selectedLine=h; getAssociatedConn(h).line.stroke('#2196f3'); }</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function handleNodeClick(node, e) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(isConnectMode) handleConnectionLogic(node);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>else if(e.evt.shiftKey) { isSelected(node)?(selectedNodes=selectedNodes.filter(n=&gt;n!==node),node.findOne('.shape-body').stroke('black').strokeWidth(2)):(selectedNodes.push(node),highlightNodes()); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>else if(!isSelected(node)) selectSingle(node);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function handleConnectionLogic(obj) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const isNode=obj.nodeType==='Group', isLine=obj.name()==='link-hit-area';</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(selectedNodes.length &amp;&amp; isLine) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const c = getAssociatedConn(obj);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if(c) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>const v = selectedNodes.filter(n =&gt; !connections.some(x=&gt;x.type==='descent'&amp;&amp;x.parentConnId===c.id&amp;&amp;x.childId===n.id()));</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>if(v.length) { saveHistory(); v.forEach(n =&gt; createDescent(c,n,Date.now()+Math.random(),false)); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>clearSelection(); return;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>let src = selectedNodes[0] || selectedLine;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(!src) { isNode?selectSingle(obj):selectLine(obj); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>else {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const sNode=src.nodeType==='Group', sLine=src.name&amp;&amp;src.name()==='link-hit-area';</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if(sNode&amp;&amp;isNode&amp;&amp;src!==obj) { if(!connections.some(c=&gt;c.type==='marriage'&amp;&amp;((c.p1Id===src.id()&amp;&amp;c.p2Id===obj.id())||(c.p1Id===obj.id()&amp;&amp;c.p2Id===src.id())))) createMarriage(src,obj); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>else if(sLine&amp;&amp;isNode) { const c=getAssociatedConn(src); if(!connections.some(x=&gt;x.type==='descent'&amp;&amp;x.parentConnId===c.id&amp;&amp;x.childId===obj.id())) createDescent(c,obj); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>else if(sNode&amp;&amp;isLine) { const c=getAssociatedConn(obj); if(!connections.some(x=&gt;x.type==='descent'&amp;&amp;x.parentConnId===c.id&amp;&amp;x.childId===src.id())) createDescent(c,src); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>clearSelection();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>const menu=document.getElementById('context-menu'), nOpts=document.getElementById('menu-node-options'), lOpts=document.getElementById('menu-line-options');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function showContextMenu(e, type) {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>menu.style.display='flex'; menu.style.top=e.evt.clientY+'px'; menu.style.left=e.evt.clientX+'px';<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>nOpts.style.display=type==='node'?'flex':'none'; lOpts.style.display=type==='line'?'flex':'none';<span class="Apple-converted-space">Â </span></p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>// Highlight buttons in Context Menu</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if (type === 'node' &amp;&amp; selectedNodes.length === 1) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const node = selectedNodes[0];</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>updateContextMenuButtons(node);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if (type === 'line' &amp;&amp; selectedLine) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>updateContextLineButtons(selectedLine);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function updateContextMenuButtons(node) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const fill = node.getAttr('fillType') || 'white';</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const isDeceased = node.getAttr('isDeceased') || false;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const isProband = node.getAttr('isProband') || false;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>['ctx-btn-white', 'ctx-btn-half', 'ctx-btn-black'].forEach(id =&gt; document.getElementById(id).classList.remove('active'));</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if (fill === 'white') document.getElementById('ctx-btn-white').classList.add('active');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>else if (fill === 'half') document.getElementById('ctx-btn-half').classList.add('active');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>else if (fill === 'black') document.getElementById('ctx-btn-black').classList.add('active');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const btnDec = document.getElementById('ctx-btn-deceased');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>isDeceased ? btnDec.classList.add('active') : btnDec.classList.remove('active');</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const btnProb = document.getElementById('ctx-btn-proband');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>isProband ? btnProb.classList.add('active') : btnProb.classList.remove('active');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function updateContextLineButtons(line) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const conn = getAssociatedConn(line);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const btnSep = document.getElementById('ctx-btn-sep');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if (conn &amp;&amp; conn.isSeparated) btnSep.classList.add('active');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>else btnSep.classList.remove('active');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function hideContextMenu() { menu.style.display='none'; }</p>
<p class="p2"><span class="Apple-converted-space">Â Â  Â  Â  Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function setShapeFill(t) { if(selectedNodes.length){ saveHistory(); selectedNodes[0].setAttr('fillType',t); applyFillStyle(selectedNodes[0].findOne('.shape-body'),t); hideContextMenu(); } }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function toggleProband() { if(selectedNodes.length){ saveHistory(); const n=selectedNodes[0],a=n.findOne('.proband-arrow'); a.visible(!a.visible()); n.setAttr('isProband',a.visible()); hideContextMenu(); } }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function toggleDeceased() { if(selectedNodes.length){ saveHistory(); const n=selectedNodes[0],s=n.findOne('.deceased-slash'); s.visible(!s.visible()); n.setAttr('isDeceased',s.visible()); hideContextMenu(); } }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function toggleSeparated() { if(selectedLine){ const c=getAssociatedConn(selectedLine); if(c.type==='marriage'){ saveHistory(); c.isSeparated=!c.isSeparated; c.slash.visible(c.isSeparated); hideContextMenu(); } } }</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function applyFillStyle(s, t) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(t==='white') { s.fill('white'); s.fillPriority('color'); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>else if(t==='black') { s.fill(DARK_GREY); s.fillPriority('color'); }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>else {<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>let sx=-20, ex=20; if(s.getClassName()==='Rect') { sx=0; ex=40; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>s.fillLinearGradientStartPoint({x:sx,y:0}); s.fillLinearGradientEndPoint({x:ex,y:0});</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>s.fillLinearGradientColorStops([0,DARK_GREY,0.5,DARK_GREY,0.5,'white',1,'white']); s.fillPriority('linear-gradient');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function toggleConnectMode() {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>isConnectMode = !isConnectMode;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const btn = document.getElementById('btn-connect');</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>clearSelection(); hideContextMenu(); closeEditor();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(isConnectMode) { btn.innerHTML = "ğŸ”— Link Mode: &lt;b&gt;ON&lt;/b&gt;"; btn.classList.add('active'); document.body.style.cursor = "crosshair"; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>else { btn.innerHTML = "ğŸ”— Link Mode: &lt;b&gt;OFF&lt;/b&gt;"; btn.classList.remove('active'); document.body.style.cursor = "default"; }</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>function downloadImage() {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>gridLayer.hide(); dragLayer.hide();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const link=document.createElement('a'); link.download='pedigree.png';</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>link.href=stage.toDataURL({ pixelRatio:2 });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>document.body.appendChild(link); link.click(); document.body.removeChild(link);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>gridLayer.show(); dragLayer.show();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>stage.on('mousedown touchstart', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>hideContextMenu(); closeEditor();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(e.target===stage &amp;&amp; e.evt.touches &amp;&amp; e.evt.touches.length &gt; 1) return; // Ignore if 2 fingers (Pan)</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(e.target===stage) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>e.evt.preventDefault(); isSelecting=true;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>// Use RELATIVE pointer for selection to work with zoom/pan</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const ptr=stage.getRelativePointerPosition();<span class="Apple-converted-space">Â </span></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>selectionStart={x:ptr.x,y:ptr.y};</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>selectionRect.visible(true); selectionRect.width(0); selectionRect.height(0); selectionRect.position(selectionStart);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>clearSelection();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>});</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>stage.on('mousemove touchmove', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(!isSelecting) return;</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const ptr=stage.getRelativePointerPosition();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>const x=Math.min(selectionStart.x,ptr.x), y=Math.min(selectionStart.y,ptr.y), w=Math.abs(ptr.x-selectionStart.x), h=Math.abs(ptr.y-selectionStart.y);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>selectionRect.position({x,y}); selectionRect.width(w); selectionRect.height(h);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>});</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>stage.on('mouseup touchend', (e) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>if(isSelecting) {</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>isSelecting=false; selectionRect.visible(false);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const box=selectionRect.getClientRect();</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>const captured=layer.find('.person-group').filter(n=&gt;Konva.Util.haveIntersection(box,n.getClientRect()));</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  Â  Â  </span>if(captured.length) selectMultiple(captured);</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  Â  Â  </span>}</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">Â  Â  Â  Â  </span>window.addEventListener('resize', () =&gt; { const d=getStageDims(); stage.width(d.width); stage.height(d.height); drawGrid(); });</p>
<p class="p1"><span class="Apple-converted-space">Â  Â  </span>&lt;/script&gt;</p>
<p class="p1">&lt;/body&gt;</p>
<p class="p1">&lt;/html&gt;</p>
</body>
</html>
